{% extends 'base.html' %}
{% load static %}

{% block title %}{% if form.instance.pk %}Edit{% else %}Create{% endif %} Material{% endblock %}

{% block extra_head %}
<style>
    .navy-gradient {
        background: linear-gradient(135deg, #243b53 0%, #334e68 100%);
    }
    .form-input-navy {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #d9e2ec;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        transition: all 0.15s ease-in-out;
        background-color: white;
    }
    .form-input-navy:focus {
        outline: none;
        border-color: #334e68;
        box-shadow: 0 0 0 3px rgba(51, 78, 104, 0.1);
    }
    .form-input-navy:hover {
        border-color: #829ab1;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Page Header -->
    <div class="mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-navy-900">
                    {% if form.instance.pk %}Edit{% else %}Create{% endif %} Material
                </h1>
                <nav class="text-sm text-gray-600 mt-2">
                    <a href="/" class="hover:text-navy-600">Dashboard</a>
                    <span class="mx-2">/</span>
                    <a href="/pricing/materials" class="hover:text-navy-600">Materials</a>
                    <span class="mx-2">/</span>
                    <span class="text-navy-900">{% if form.instance.pk %}Edit{% else %}Create{% endif %}</span>
                </nav>
            </div>
            <a href="/pricing/materials" class="bg-white text-navy-700 px-4 py-2 rounded-lg border border-navy-300 hover:bg-navy-50 transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>Back to Materials
            </a>
        </div>
    </div>

    <form method="post" enctype="multipart/form-data" class="space-y-6">
        {% csrf_token %}
        
        {% if form.non_field_errors %}
        <div class="bg-red-50 border border-red-300 text-red-800 px-4 py-3 rounded-lg">
            <i class="fas fa-exclamation-triangle mr-2"></i>{{ form.non_field_errors }}
        </div>
        {% endif %}

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Main Content (2/3 width) -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Basic Information -->
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="navy-gradient text-white px-6 py-4">
                        <h2 class="text-lg font-semibold flex items-center">
                            <i class="fas fa-cube mr-2"></i>Basic Information
                        </h2>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-navy-700 mb-1">
                                    Material Code <span class="text-red-500">*</span>
                                </label>
                                <input type="text" name="code" value="{{ form.code.value|default:'' }}" 
                                       class="form-input-navy" placeholder="e.g., MAT-001" required>
                                {% if form.code.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.code.errors.0 }}</p>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-navy-700 mb-1">
                                    Material Name <span class="text-red-500">*</span>
                                </label>
                                <input type="text" name="name" value="{{ form.name.value|default:'' }}" 
                                       class="form-input-navy" placeholder="Enter material name" required>
                                {% if form.name.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.name.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-navy-700 mb-1">
                                Description
                            </label>
                            <textarea name="description" rows="3" class="form-input-navy" 
                                      placeholder="Describe the material...">{{ form.description.value|default:'' }}</textarea>
                            {% if form.description.errors %}
                            <p class="text-red-500 text-xs mt-1">{{ form.description.errors.0 }}</p>
                            {% endif %}
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-navy-700 mb-1">
                                    Material Type <span class="text-red-500">*</span>
                                </label>
                                <select name="material_type" class="form-input-navy" required>
                                    <option value="">Select type...</option>
                                    <option value="raw_material" {% if form.material_type.value == 'raw_material' %}selected{% endif %}>Raw Material</option>
                                    <option value="component" {% if form.material_type.value == 'component' %}selected{% endif %}>Component</option>
                                    <option value="assembly" {% if form.material_type.value == 'assembly' %}selected{% endif %}>Assembly</option>
                                    <option value="finished_good" {% if form.material_type.value == 'finished_good' %}selected{% endif %}>Finished Good</option>
                                    <option value="service" {% if form.material_type.value == 'service' %}selected{% endif %}>Service</option>
                                </select>
                                {% if form.material_type.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.material_type.errors.0 }}</p>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-navy-700 mb-1">
                                    Category
                                </label>
                                <select name="category" class="form-input-navy">
                                    <option value="">Select category...</option>
                                    {% for category in form.fields.category.queryset %}
                                    <option value="{{ category.pk }}" {% if form.category.value == category.pk|stringformat:"s" %}selected{% endif %}>
                                        {{ category.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                {% if form.category.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.category.errors.0 }}</p>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-navy-700 mb-1">
                                    Status <span class="text-red-500">*</span>
                                </label>
                                <select name="status" class="form-input-navy" required>
                                    <option value="active" {% if form.status.value == 'active' %}selected{% endif %}>Active</option>
                                    <option value="inactive" {% if form.status.value == 'inactive' %}selected{% endif %}>Inactive</option>
                                    <option value="discontinued" {% if form.status.value == 'discontinued' %}selected{% endif %}>Discontinued</option>
                                    <option value="development" {% if form.status.value == 'development' %}selected{% endif %}>In Development</option>
                                </select>
                                {% if form.status.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.status.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Physical Properties -->
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="navy-gradient text-white px-6 py-4">
                        <h2 class="text-lg font-semibold flex items-center">
                            <i class="fas fa-ruler mr-2"></i>Physical Properties
                        </h2>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-navy-700 mb-1">
                                    Unit of Measure <span class="text-red-500">*</span>
                                </label>
                                <input type="text" name="unit_of_measure" value="{{ form.unit_of_measure.value|default:'' }}" 
                                       class="form-input-navy" placeholder="e.g., kg, pcs, meters" required>
                                {% if form.unit_of_measure.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.unit_of_measure.errors.0 }}</p>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-navy-700 mb-1">
                                    Weight
                                </label>
                                <input type="number" name="weight" value="{{ form.weight.value|default:'' }}" 
                                       class="form-input-navy" placeholder="0.00" step="0.0001">
                                {% if form.weight.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.weight.errors.0 }}</p>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-navy-700 mb-1">
                                    Weight Unit
                                </label>
                                <select name="weight_unit" class="form-input-navy">
                                    <option value="kg" {% if form.weight_unit.value == 'kg' %}selected{% endif %}>kg</option>
                                    <option value="g" {% if form.weight_unit.value == 'g' %}selected{% endif %}>g</option>
                                    <option value="lb" {% if form.weight_unit.value == 'lb' %}selected{% endif %}>lb</option>
                                    <option value="oz" {% if form.weight_unit.value == 'oz' %}selected{% endif %}>oz</option>
                                </select>
                                {% if form.weight_unit.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.weight_unit.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pricing Information -->
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="navy-gradient text-white px-6 py-4">
                        <h2 class="text-lg font-semibold flex items-center">
                            <i class="fas fa-dollar-sign mr-2"></i>Pricing Information
                        </h2>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-navy-700 mb-1">
                                    List Price
                                </label>
                                <div class="relative">
                                    <span class="absolute left-3 top-2 text-gray-500">$</span>
                                    <input type="number" name="list_price" value="{{ form.list_price.value|default:'' }}" 
                                           class="form-input-navy pl-8" placeholder="0.00" step="0.0001">
                                </div>
                                {% if form.list_price.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.list_price.errors.0 }}</p>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-navy-700 mb-1">
                                    Cost Price
                                </label>
                                <div class="relative">
                                    <span class="absolute left-3 top-2 text-gray-500">$</span>
                                    <input type="number" name="cost_price" value="{{ form.cost_price.value|default:'' }}" 
                                           class="form-input-navy pl-8" placeholder="0.00" step="0.0001">
                                </div>
                                {% if form.cost_price.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.cost_price.errors.0 }}</p>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-navy-700 mb-1">
                                    Currency
                                </label>
                                <input type="text" name="currency" value="{{ form.currency.value|default:'USD' }}" 
                                       class="form-input-navy" placeholder="USD" maxlength="3">
                                {% if form.currency.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.currency.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-navy-700 mb-1">
                                    Lead Time (days)
                                </label>
                                <input type="number" name="lead_time_days" value="{{ form.lead_time_days.value|default:'' }}" 
                                       class="form-input-navy" placeholder="0" min="0">
                                {% if form.lead_time_days.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.lead_time_days.errors.0 }}</p>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-navy-700 mb-1">
                                    Minimum Order Quantity
                                </label>
                                <input type="number" name="minimum_order_quantity" value="{{ form.minimum_order_quantity.value|default:'' }}" 
                                       class="form-input-navy" placeholder="0" step="0.0001">
                                {% if form.minimum_order_quantity.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.minimum_order_quantity.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar (1/3 width) -->
            <div class="space-y-6">
                <!-- Quick Info -->
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="bg-navy-50 px-6 py-4 border-b border-navy-100">
                        <h3 class="text-sm font-semibold text-navy-900 flex items-center">
                            <i class="fas fa-info-circle mr-2"></i>Quick Info
                        </h3>
                    </div>
                    <div class="p-6 space-y-3 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Created By:</span>
                            <span class="font-medium text-navy-900">{{ request.user.username }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Organization:</span>
                            <span class="font-medium text-navy-900">{{ request.user.profile.organization.name|truncatechars:20 }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Date:</span>
                            <span class="font-medium text-navy-900">{% now "M j, Y" %}</span>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="p-6 space-y-3">
                        <button type="submit" name="save" 
                                class="w-full bg-navy-700 text-white px-4 py-2 rounded-lg hover:bg-navy-800 transition-colors">
                            <i class="fas fa-check mr-2"></i>
                            {% if form.instance.pk %}Update{% else %}Create{% endif %} Material
                        </button>
                        <button type="submit" name="save_and_continue" 
                                class="w-full bg-gray-100 text-navy-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors">
                            <i class="fas fa-save mr-2"></i>Save and Continue
                        </button>
                        <a href="/pricing/materials" 
                           class="block w-full text-center bg-white text-gray-600 px-4 py-2 rounded-lg border border-gray-300 hover:bg-gray-50 transition-colors">
                            <i class="fas fa-times mr-2"></i>Cancel
                        </a>
                    </div>
                </div>

                <!-- Tips -->
                <div class="bg-blue-50 rounded-xl p-4">
                    <h4 class="text-sm font-semibold text-blue-900 mb-2">
                        <i class="fas fa-lightbulb mr-2"></i>Tips
                    </h4>
                    <ul class="text-xs text-blue-700 space-y-1">
                        <li>• Use a consistent naming convention for material codes</li>
                        <li>• Include detailed descriptions for better searchability</li>
                        <li>• Set accurate lead times for procurement planning</li>
                        <li>• Keep pricing information up to date</li>
                    </ul>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-generate material code if empty
    const codeField = document.querySelector('input[name="code"]');
    const nameField = document.querySelector('input[name="name"]');
    
    if (codeField && !codeField.value && nameField) {
        nameField.addEventListener('blur', function() {
            if (!codeField.value && nameField.value) {
                // Generate code from name
                const prefix = nameField.value.substring(0, 3).toUpperCase();
                const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
                codeField.value = `${prefix}-${random}`;
            }
        });
    }
    
    // Handle save and continue
    const saveAndContinueBtn = document.querySelector('button[name="save_and_continue"]');
    if (saveAndContinueBtn) {
        saveAndContinueBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const form = document.getElementById('materialForm') || document.querySelector('form');
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'save_and_continue';
            input.value = '1';
            form.appendChild(input);
            form.submit();
        });
    }
});
</script>
{% endblock %}