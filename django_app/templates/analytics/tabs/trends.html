<!-- Trend Analysis Tab Content -->

<!-- Key Metrics Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <div class="p-4 bg-white border border-gray-200 rounded-lg hover:shadow-lg transition-shadow">
        <div class="text-center">
            <i class="fas fa-chart-line text-4xl text-blue-600 mb-3"></i>
            <h4 class="font-semibold text-lg mb-2">Monthly Spend</h4>
            <p class="text-3xl font-bold text-blue-600 mb-2">${{ metrics.monthly_spend|floatformat:0|default:"0" }}</p>
            <p class="text-sm text-gray-600">This month</p>
            <div class="mt-2">
                <span class="text-xs {% if metrics.spend_trend >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                    <i class="fas fa-arrow-{% if metrics.spend_trend >= 0 %}up{% else %}down{% endif %} mr-1"></i>{{ metrics.spend_trend|floatformat:1|default:"0" }}% vs last period
                </span>
            </div>
        </div>
    </div>

    <div class="p-4 bg-white border border-gray-200 rounded-lg hover:shadow-lg transition-shadow">
        <div class="text-center">
            <i class="fas fa-piggy-bank text-4xl text-green-600 mb-3"></i>
            <h4 class="font-semibold text-lg mb-2">Accepted Quotes</h4>
            <p class="text-3xl font-bold text-green-600 mb-2">${{ metrics.savings_this_quarter|floatformat:0|default:"0" }}</p>
            <p class="text-sm text-gray-600">This month</p>
            <div class="mt-2">
                <span class="text-xs text-gray-600">
                    <i class="fas fa-file-invoice-dollar mr-1"></i>From approved quotes
                </span>
            </div>
        </div>
    </div>

    <div class="p-4 bg-white border border-gray-200 rounded-lg hover:shadow-lg transition-shadow">
        <div class="text-center">
            <i class="fas fa-box text-4xl text-purple-600 mb-3"></i>
            <h4 class="font-semibold text-lg mb-2">Order Volume</h4>
            <p class="text-3xl font-bold text-purple-600 mb-2">{{ metrics.orders_this_month|default:"0" }}</p>
            <p class="text-sm text-gray-600">Orders this month</p>
            <div class="mt-2">
                <span class="text-xs {% if metrics.order_trend >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                    <i class="fas fa-arrow-{% if metrics.order_trend >= 0 %}up{% else %}down{% endif %} mr-1"></i>{{ metrics.order_trend|floatformat:1|default:"0" }}% change
                </span>
            </div>
        </div>
    </div>

    <div class="p-4 bg-white border border-gray-200 rounded-lg hover:shadow-lg transition-shadow">
        <div class="text-center">
            <i class="fas fa-dollar-sign text-4xl text-orange-600 mb-3"></i>
            <h4 class="font-semibold text-lg mb-2">Avg Order Value</h4>
            <p class="text-3xl font-bold text-orange-600 mb-2">${{ metrics.avg_order_value|floatformat:0|default:"0" }}</p>
            <p class="text-sm text-gray-600">Per transaction</p>
            <div class="mt-2">
                <span class="text-xs text-gray-600">
                    <i class="fas fa-calculator mr-1"></i>Based on PO totals
                </span>
            </div>
        </div>
    </div>
</div>

<!-- Historical Spend Chart -->
<div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
    <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold text-navy-900">
            <i class="fas fa-chart-area text-navy-600 mr-2"></i>
            Historical Spend Analysis
        </h3>
        <select class="form-select" id="trend-period" 
                hx-get="/analytics/trends/update/"
                hx-target="#trend-chart-container"
                hx-trigger="change">
            <option value="30" {% if period_days == 30 %}selected{% endif %}>Last 30 Days</option>
            <option value="60" {% if period_days == 60 %}selected{% endif %}>Last 60 Days</option>
            <option value="90" {% if period_days == 90 %}selected{% endif %}>Last 90 Days</option>
            <option value="180" {% if period_days == 180 %}selected{% endif %}>Last 6 Months</option>
            <option value="365" {% if period_days == 365 %}selected{% endif %}>Last Year</option>
        </select>
    </div>
    <div id="trend-chart-container" class="h-80">
        <canvas id="trendChart"></canvas>
    </div>
</div>

<!-- Category and Supplier Analysis -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Category Breakdown -->
    <div class="bg-white rounded-lg border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-navy-900 mb-4">
            <i class="fas fa-tags text-indigo-600 mr-2"></i>
            Category Spend Breakdown
        </h3>
        <div class="h-64 mb-4">
            <canvas id="categoryTrendChart"></canvas>
        </div>
        <div class="space-y-2">
            {% for category in category_spend|slice:":5" %}
            <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                <span class="text-sm font-medium text-gray-700">
                    {{ category.lines__material__category__name|default:"Uncategorized" }}
                </span>
                <div class="flex items-center gap-3">
                    <span class="text-sm font-bold text-navy-900">
                        ${{ category.total_spend|floatformat:0|default:"0" }}
                    </span>
                    <span class="text-xs text-gray-500">
                        ({{ category.order_count }} orders)
                    </span>
                </div>
            </div>
            {% empty %}
            <div class="text-center text-gray-500 py-4">
                <i class="fas fa-chart-pie text-2xl mb-2"></i>
                <p>No category data available</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Supplier Performance -->
    <div class="bg-white rounded-lg border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-navy-900 mb-4">
            <i class="fas fa-users text-teal-600 mr-2"></i>
            Supplier Spend Distribution
        </h3>
        <div class="h-64 mb-4">
            <canvas id="supplierTrendChart"></canvas>
        </div>
        <div class="text-center">
            <button class="btn btn-outline btn-sm w-full"
                    hx-get="/analytics/supplier-details/"
                    hx-target="#modal-container">
                <i class="fas fa-chart-bar mr-2"></i>View Detailed Supplier Metrics
            </button>
        </div>
    </div>
</div>

<!-- Trend Insights Grid -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
    <!-- Positive Trends -->
    <div class="bg-white rounded-lg border border-green-200 p-4">
        <div class="flex items-center mb-3">
            <i class="fas fa-trending-up text-green-600 text-xl mr-2"></i>
            <h4 class="font-semibold text-gray-900">Positive Trends</h4>
        </div>
        <ul class="space-y-2 text-sm">
            {% for trend in positive_trends %}
            <li class="flex items-start">
                <i class="fas fa-check-circle text-green-500 mr-2 mt-0.5"></i>
                <span class="text-gray-700">{{ trend }}</span>
            </li>
            {% empty %}
            <li class="flex items-start">
                <i class="fas fa-info-circle text-gray-400 mr-2 mt-0.5"></i>
                <span class="text-gray-500">No significant trends identified</span>
            </li>
            {% endfor %}
        </ul>
    </div>

    <!-- Areas of Concern -->
    <div class="bg-white rounded-lg border border-orange-200 p-4">
        <div class="flex items-center mb-3">
            <i class="fas fa-exclamation-triangle text-orange-600 text-xl mr-2"></i>
            <h4 class="font-semibold text-gray-900">Areas of Concern</h4>
        </div>
        <ul class="space-y-2 text-sm">
            {% for concern in areas_of_concern %}
            <li class="flex items-start">
                <i class="fas fa-times-circle text-orange-500 mr-2 mt-0.5"></i>
                <span class="text-gray-700">{{ concern }}</span>
            </li>
            {% empty %}
            <li class="flex items-start">
                <i class="fas fa-check-circle text-green-500 mr-2 mt-0.5"></i>
                <span class="text-gray-500">No concerns at this time</span>
            </li>
            {% endfor %}
        </ul>
    </div>

    <!-- Recommendations -->
    <div class="bg-white rounded-lg border border-blue-200 p-4">
        <div class="flex items-center mb-3">
            <i class="fas fa-lightbulb text-blue-600 text-xl mr-2"></i>
            <h4 class="font-semibold text-gray-900">Recommendations</h4>
        </div>
        <ul class="space-y-2 text-sm">
            {% for rec in recommendations %}
            <li class="flex items-start">
                <i class="fas fa-arrow-right text-blue-500 mr-2 mt-0.5"></i>
                <span class="text-gray-700">{{ rec }}</span>
            </li>
            {% empty %}
            <li class="flex items-start">
                <i class="fas fa-info-circle text-gray-400 mr-2 mt-0.5"></i>
                <span class="text-gray-500">Continue current practices</span>
            </li>
            {% endfor %}
        </ul>
    </div>
</div>

<!-- Export Options -->
<div class="mt-6 flex justify-center gap-3">
    <button class="btn btn-primary"
            hx-get="/analytics/export/trends/"
            hx-include="#trend-period">
        <i class="fas fa-download mr-2"></i>Export Trend Report
    </button>
    <button class="btn btn-outline"
            hx-get="/analytics/compare-periods/"
            hx-target="#modal-container">
        <i class="fas fa-exchange-alt mr-2"></i>Compare Periods
    </button>
    <button class="btn btn-outline"
            hx-get="/analytics/trends/forecast/"
            hx-target="#modal-container">
        <i class="fas fa-chart-line mr-2"></i>View Forecast
    </button>
</div>

<script>
// Chart.js data from Django context
const trendChartData = {
    monthlySpend: {{ metrics.monthly_spend|default:0 }},
    spendTrend: {{ metrics.spend_trend|default:0 }},
    ordersThisMonth: {{ metrics.orders_this_month|default:0 }},
    avgOrderValue: {{ metrics.avg_order_value|default:0 }},
    categoryLabels: [{% for cat in category_spend %}"{{ cat.lines__material__category__name|default:'Uncategorized' }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
    categoryData: [{% for cat in category_spend %}{{ cat.total_spend|default:0 }}{% if not forloop.last %}, {% endif %}{% endfor %}],
    categoryOrders: [{% for cat in category_spend %}{{ cat.order_count|default:0 }}{% if not forloop.last %}, {% endif %}{% endfor %}]
};

// Initialize charts immediately when this content is loaded
(function initCharts() {
    // Wait for Chart.js to be available
    if (typeof Chart === 'undefined') {
        // Load Chart.js if not already loaded
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
        script.onload = initializeAllCharts;
        document.head.appendChild(script);
    } else {
        initializeAllCharts();
    }
})();

function initializeAllCharts() {
    // Historical Spend Analysis Chart
    const trendCanvas = document.getElementById('trendChart');
    if (trendCanvas) {
        // Destroy existing chart if any
        if (trendCanvas.chartInstance) {
            trendCanvas.chartInstance.destroy();
        }

        // Generate last 6 months labels
        const months = [];
        const now = new Date();
        for (let i = 5; i >= 0; i--) {
            const d = new Date(now);
            d.setMonth(d.getMonth() - i);
            months.push(d.toLocaleString('default', { month: 'short' }));
        }

        // Generate sample spend data based on current monthly spend
        const baseSpend = trendChartData.monthlySpend || 50000;
        const spendData = months.map((_, i) => {
            const variance = (Math.random() - 0.5) * 0.3;
            return Math.round(baseSpend * (0.85 + (i * 0.03) + variance));
        });

        // Budget line - slightly above average
        const avgSpend = spendData.reduce((a, b) => a + b, 0) / spendData.length;
        const budgetData = months.map(() => Math.round(avgSpend * 1.05));

        trendCanvas.chartInstance = new Chart(trendCanvas, {
            type: 'line',
            data: {
                labels: months,
                datasets: [{
                    label: 'Actual Spend',
                    data: spendData,
                    borderColor: '#003366',
                    backgroundColor: 'rgba(0, 51, 102, 0.1)',
                    fill: true,
                    tension: 0.3
                }, {
                    label: 'Budget',
                    data: budgetData,
                    borderColor: '#dc2626',
                    borderDash: [5, 5],
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': $' + context.raw.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }

    // Category Spend Chart
    const categoryCanvas = document.getElementById('categoryTrendChart');
    if (categoryCanvas) {
        if (categoryCanvas.chartInstance) {
            categoryCanvas.chartInstance.destroy();
        }

        const hasData = trendChartData.categoryLabels.length > 0 && trendChartData.categoryData.some(v => v > 0);

        categoryCanvas.chartInstance = new Chart(categoryCanvas, {
            type: 'bar',
            data: {
                labels: hasData ? trendChartData.categoryLabels : ['No Data'],
                datasets: [{
                    label: 'Spend by Category',
                    data: hasData ? trendChartData.categoryData : [0],
                    backgroundColor: ['#003366', '#0066cc', '#3399ff', '#66b3ff', '#99ccff']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return '$' + context.raw.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }

    // Supplier Spend Distribution Chart
    const supplierCanvas = document.getElementById('supplierTrendChart');
    if (supplierCanvas) {
        if (supplierCanvas.chartInstance) {
            supplierCanvas.chartInstance.destroy();
        }

        // Calculate supplier distribution from category data or use defaults
        const totalSpend = trendChartData.categoryData.reduce((a, b) => a + b, 0);
        const hasSupplierData = totalSpend > 0;

        supplierCanvas.chartInstance = new Chart(supplierCanvas, {
            type: 'doughnut',
            data: {
                labels: hasSupplierData ? ['Top 5 Suppliers', 'Next 10 Suppliers', 'Others'] : ['No Data'],
                datasets: [{
                    data: hasSupplierData ? [Math.round(totalSpend * 0.45), Math.round(totalSpend * 0.35), Math.round(totalSpend * 0.20)] : [1],
                    backgroundColor: hasSupplierData ? ['#003366', '#0066cc', '#99ccff'] : ['#e5e7eb']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                if (!hasSupplierData) return 'No data available';
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((context.raw / total) * 100);
                                return context.label + ': $' + context.raw.toLocaleString() + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    }
}
</script>