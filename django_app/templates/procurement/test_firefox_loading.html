{% extends "base_modern.html" %}
{% load static %}

{% block title %}Firefox Loading Test{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-white">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-navy-800 mb-6">Firefox Loading Test Page</h1>

        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Browser Information</h2>
            <p>User Agent: <span id="user-agent" class="font-mono text-sm"></span></p>
            <p>Is Firefox: <span id="is-firefox" class="font-bold"></span></p>
            <p>Loading Status: <span id="loading-status" class="font-bold text-green-600">Page Loaded</span></p>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4">Debug Console</h2>
            <div id="debug-console" class="font-mono text-sm bg-gray-100 p-4 rounded max-h-64 overflow-y-auto">
                <div>Console output will appear here...</div>
            </div>
        </div>

        <div class="mt-6">
            <button onclick="window.showLoading()" class="btn btn-primary mr-4">Show Loading</button>
            <button onclick="window.hideLoading()" class="btn btn-secondary mr-4">Hide Loading</button>
            <button onclick="testHideAll()" class="btn btn-success">Test Hide All</button>
        </div>
    </div>
</div>
{% endblock %}

{% block page_scripts %}
<script>
// Debug console logging
function logDebug(message) {
    const consoleDiv = document.getElementById('debug-console');
    const timestamp = new Date().toLocaleTimeString();
    const entry = document.createElement('div');
    entry.textContent = `[${timestamp}] ${message}`;
    consoleDiv.appendChild(entry);
    console.log(message);
}

// Detect Firefox
const isFirefox = navigator.userAgent.toLowerCase().indexOf('firefox') > -1;
document.getElementById('user-agent').textContent = navigator.userAgent;
document.getElementById('is-firefox').textContent = isFirefox ? 'YES (Firefox Detected)' : 'NO';

if (isFirefox) {
    document.getElementById('is-firefox').classList.add('text-orange-600');
}

// Enhanced loading indicator removal
function testHideAll() {
    logDebug('Testing hide all loading indicators...');

    // Try the global function
    if (typeof window.hideLoading === 'function') {
        window.hideLoading();
        logDebug('Called window.hideLoading()');
    }

    // Try to find and hide loading overlay
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
        overlay.classList.add('hidden');
        overlay.style.display = 'none';
        logDebug('Found and hid loading-overlay');
    } else {
        logDebug('No loading-overlay element found');
    }

    // Check all elements with loading-related classes
    const loadingElements = document.querySelectorAll('[class*="loading"], [id*="loading"]');
    logDebug(`Found ${loadingElements.length} elements with loading-related classes/IDs`);

    loadingElements.forEach((el, index) => {
        if (el.textContent && el.textContent.includes('Loading')) {
            logDebug(`Element ${index}: ${el.tagName} with text "${el.textContent.substring(0, 50)}"`);
            el.style.display = 'none';
        }
    });

    document.getElementById('loading-status').textContent = 'All loading indicators hidden';
    document.getElementById('loading-status').classList.add('text-green-600');
}

// Log page load events
document.addEventListener('DOMContentLoaded', function() {
    logDebug('DOMContentLoaded event fired');

    // Check for loading overlay
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
        logDebug(`Loading overlay found: classes="${overlay.className}", display="${overlay.style.display}"`);
        if (!overlay.classList.contains('hidden')) {
            logDebug('WARNING: Loading overlay is visible!');
            // Hide it
            overlay.classList.add('hidden');
            logDebug('Added hidden class to loading overlay');
        }
    } else {
        logDebug('No loading overlay found in DOM');
    }
});

window.addEventListener('load', function() {
    logDebug('Window load event fired');
});

// Check immediately
logDebug('Script initialized');
logDebug('Document ready state: ' + document.readyState);

// Firefox-specific checks
if (isFirefox) {
    logDebug('Running Firefox-specific checks...');

    // Try to hide loading after various delays
    setTimeout(() => {
        const overlay = document.getElementById('loading-overlay');
        if (overlay && !overlay.classList.contains('hidden')) {
            logDebug('Firefox: Found visible loading overlay after 100ms, hiding it');
            overlay.classList.add('hidden');
        }
    }, 100);

    setTimeout(() => {
        const overlay = document.getElementById('loading-overlay');
        if (overlay && !overlay.classList.contains('hidden')) {
            logDebug('Firefox: Found visible loading overlay after 500ms, hiding it');
            overlay.classList.add('hidden');
        }
    }, 500);
}
</script>
{% endblock %}