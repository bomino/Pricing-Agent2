{% extends 'base_modern.html' %}
{% load static %}

{% block title %}Resolve Conflict - {{ conflict.incoming_value }}{% endblock %}

{% block extra_head %}
<style>
    .match-option {
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    .match-option:hover {
        background-color: #f3f4f6;
        border-color: #3b82f6;
    }
    .match-option.selected {
        background-color: #eff6ff;
        border-color: #3b82f6;
    }
    .similarity-meter {
        height: 8px;
        border-radius: 4px;
        background: linear-gradient(to right, #ef4444 0%, #f59e0b 50%, #10b981 100%);
        position: relative;
        overflow: hidden;
    }
    .similarity-indicator {
        position: absolute;
        top: -4px;
        width: 16px;
        height: 16px;
        background: white;
        border: 2px solid #374151;
        border-radius: 50%;
        transform: translateX(-50%);
    }
    .staging-data-row {
        display: grid;
        grid-template-columns: 150px 1fr;
        gap: 1rem;
        padding: 0.5rem 0;
        border-bottom: 1px solid #e5e7eb;
    }
    .staging-data-row:last-child {
        border-bottom: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="p-6">
    <div class="max-w-5xl mx-auto">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Resolve Matching Conflict</h1>
                    <p class="text-gray-600 mt-1">
                        {% if conflict.conflict_type == 'supplier' %}
                            <i class="fas fa-building text-blue-500"></i> Supplier Match
                        {% else %}
                            <i class="fas fa-cube text-green-500"></i> Material Match
                        {% endif %}
                    </p>
                </div>
                <a href="{% url 'data_ingestion:conflict_list' conflict.upload.id %}"
                   class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                    <i class="fas fa-list mr-2"></i>Back to List
                </a>
            </div>
        </div>

        <!-- Current Status -->
        {% if conflict.status != 'pending' %}
        <div class="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
            <p class="text-green-800">
                <i class="fas fa-check-circle mr-2"></i>
                This conflict has been resolved as <strong>{{ conflict.get_status_display }}</strong>
                {% if conflict.resolved_by %}
                by {{ conflict.resolved_by.username }} on {{ conflict.resolved_at|date:"M j, Y g:i A" }}
                {% endif %}
            </p>
            {% if conflict.resolution_notes %}
            <p class="text-green-700 mt-2">Notes: {{ conflict.resolution_notes }}</p>
            {% endif %}
        </div>
        {% endif %}

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Left Column: Incoming Data -->
            <div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-file-import text-blue-500 mr-2"></i>Incoming Data
                    </h2>

                    <div class="mb-6">
                        <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <p class="text-xl font-semibold text-blue-900">{{ conflict.incoming_value }}</p>
                            {% if conflict.incoming_code %}
                            <p class="text-sm text-blue-700 mt-1">Code: {{ conflict.incoming_code }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Staging Record Data -->
                    <div>
                        <h3 class="text-md font-medium text-gray-700 mb-3">Full Record Data</h3>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            {% for key, value in staging_data.items %}
                            <div class="staging-data-row">
                                <span class="text-sm font-medium text-gray-600">{{ key|title|cut:"_" }}</span>
                                <span class="text-sm text-gray-900">{{ value|default:"â€”" }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Potential Matches -->
            <div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-search text-green-500 mr-2"></i>Potential Matches
                    </h2>

                    {% if conflict.potential_matches %}
                    <div class="space-y-3 mb-6">
                        {% for match in conflict.potential_matches %}
                        <div class="match-option p-4 border rounded-lg"
                             onclick="selectMatch(this, '{{ match.id }}')"
                             data-match-id="{{ match.id }}">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1">
                                    <p class="font-medium text-gray-900">{{ match.name }}</p>
                                    {% if match.code %}
                                    <p class="text-sm text-gray-600">Code: {{ match.code }}</p>
                                    {% endif %}
                                </div>
                                <div class="text-right">
                                    <p class="text-lg font-bold
                                        {% if match.similarity >= 90 %}text-green-600
                                        {% elif match.similarity >= 80 %}text-yellow-600
                                        {% else %}text-gray-600{% endif %}">
                                        {{ match.similarity|floatformat:0 }}%
                                    </p>
                                    <p class="text-xs text-gray-500">match</p>
                                </div>
                            </div>

                            <!-- Similarity Meter -->
                            <div class="similarity-meter">
                                <div class="similarity-indicator" style="left: {{ match.similarity }}%"></div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg mb-6">
                        <p class="text-yellow-800">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            No automatic matches found. This appears to be a new record.
                        </p>
                    </div>
                    {% endif %}

                    <!-- Additional Context Data -->
                    {% if context_data %}
                    <div class="mb-6">
                        <h3 class="text-md font-medium text-gray-700 mb-3">
                            Other Existing {% if conflict.conflict_type == 'supplier' %}Suppliers{% else %}Materials{% endif %}
                        </h3>
                        <div class="bg-gray-50 p-4 rounded-lg max-h-48 overflow-y-auto">
                            {% for item in context_data %}
                            <div class="py-1 text-sm">
                                <span class="font-medium">{{ item.name }}</span>
                                {% if item.code %}
                                <span class="text-gray-500">({{ item.code }})</span>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Resolution Actions -->
                {% if conflict.status == 'pending' %}
                <div class="bg-white p-6 rounded-lg shadow mt-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Resolution</h3>

                    <form id="resolution-form" method="post" action="{% url 'data_ingestion:resolve_conflict' conflict.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="resolution_type" id="resolution_type" value="">
                        <input type="hidden" name="matched_id" id="matched_id" value="">

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Resolution Notes (Optional)</label>
                            <textarea name="notes" rows="3"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                      placeholder="Add any notes about this resolution..."></textarea>
                        </div>

                        <div class="flex gap-3">
                            <button type="button"
                                    onclick="resolveAsMatch()"
                                    class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                <i class="fas fa-link mr-2"></i>Match to Selected
                            </button>
                            <button type="button"
                                    onclick="resolveAsNew()"
                                    class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                <i class="fas fa-plus-circle mr-2"></i>Create New Record
                            </button>
                        </div>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
let selectedMatchId = null;

function selectMatch(element, matchId) {
    // Remove previous selection
    document.querySelectorAll('.match-option').forEach(el => {
        el.classList.remove('selected');
    });

    // Add selection to clicked element
    element.classList.add('selected');
    selectedMatchId = matchId;
}

function resolveAsMatch() {
    if (!selectedMatchId && {{ conflict.potential_matches|length }} > 0) {
        alert('Please select a match from the list');
        return;
    }

    if (!confirm('Confirm matching to the selected record?')) {
        return;
    }

    document.getElementById('resolution_type').value = 'match';
    document.getElementById('matched_id').value = selectedMatchId || '';
    document.getElementById('resolution-form').submit();
}

function resolveAsNew() {
    if (!confirm('Confirm creating a new record?')) {
        return;
    }

    document.getElementById('resolution_type').value = 'new';
    document.getElementById('resolution-form').submit();
}

// Auto-select if there's only one high-confidence match
document.addEventListener('DOMContentLoaded', function() {
    const matches = document.querySelectorAll('.match-option');
    if (matches.length === 1) {
        const match = matches[0];
        const matchId = match.dataset.matchId;
        selectMatch(match, matchId);
    }
});
</script>
{% endblock %}